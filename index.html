<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MajMarket</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0C0C10; --card:#111117; --line:#252530; --text:#FFFFFF; --muted:#CFCFDE;
      --accent:#E93E8F; --ok:#2DD688; --warn:#E5C15A; --err:#FF4A4A;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial}
    .app{min-height:100vh;display:flex;flex-direction:column}
    .container{max-width:980px;margin:0 auto;padding:16px 16px 84px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .hero{background:linear-gradient(180deg,#111117, #0C0C10);border:1px solid var(--line);border-radius:18px;padding:18px;margin:10px 0}
    .hero h2{margin:0 0 6px 0}
    .chip{border:1px solid var(--line);border-radius:12px;padding:6px 10px;color:var(--muted);font-size:13px}
    .btn{background:var(--accent);border:0;color:#fff;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
    .btn.secondary{background:#1a1a21;border:1px solid var(--line);color:#fff}
    .btn.sm{padding:8px 12px;font-weight:600}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .card h4{margin:0 0 6px}
    .meta{color:var(--muted);font-size:13px;margin:4px 0 10px}
    .price{color:var(--accent);font-weight:800}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    input,select,textarea{width:100%;background:#0f0f14;color:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 0}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:14px;padding:8px 12px}
    .pill .ic{font-size:18px}
    .bignum{font-size:24px;font-weight:800}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:90px;background:#15151d;border:1px solid var(--line);padding:10px 14px;border-radius:10px;display:none;z-index:20}
    .tabbar{position:fixed;left:0;right:0;bottom:0;background:#0B0B0F;border-top:1px solid var(--line);display:flex}
    .tabbar button{flex:1;background:transparent;border:0;color:#CFCFDE;padding:10px 6px;font-weight:700;font-size:14px}
    .tabbar button .t{display:block;font-size:12px;font-weight:600;opacity:.9}
    .tabbar button.active{color:#fff;border-top:2px solid var(--accent)}
    .icon{font-size:20px}
    .range-wrap{padding:12px;border:1px solid var(--line);border-radius:14px;background:#0f0f14}
    .range{width:100%;-webkit-appearance:none;height:8px;border-radius:6px;background:#2a2a33;outline:none}
    .range::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:var(--accent);border:2px solid #fff;cursor:pointer}
    a.link{color:var(--accent);text-decoration:none}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
<div class="app">
  <div class="container">
    <div id="screen"></div>
  </div>

  <div class="tabbar">
    <button id="tab-home"     onclick="App.route('home')">üè†<span class='t'>–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button id="tab-trade"    onclick="App.route('trade')">üõí<span class='t'>–¢–æ—Ä–≥–æ–≤–ª—è</span></button>
    <button id="tab-settings" onclick="App.route('settings')">‚öôÔ∏è<span class='t'>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
    <button id="tab-mod"      onclick="App.route('moderation')">üõ°Ô∏è<span class='t'>–ú–æ–¥–µ—Ä–∞—Ü–∏—è</span></button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const MJT_RUB = 2;   // 1 MJT = 2‚ÇΩ
const FEE = 0.03;    // 3% –∫–æ–º–∏—Å—Å–∏—è

const API = {
  async call(path, method='GET', body){
    const r = await fetch(path, {
      method,
      headers:{ 'Content-Type':'application/json' },
      body: body ? JSON.stringify(body) : undefined
    });
    return r.json();
  }
};

const Store = {
  key: 'majmarket-state',
  load(){
    try{ const raw = localStorage.getItem(this.key); if(!raw) return this.seed(); return JSON.parse(raw); }
    catch(e){ return this.seed(); }
  },
  seed(){
    return { user:{}, role:'user', wallet:{ balance:1000, hold:0, history:[] }, orders_cache:[] };
  },
  save(data){ localStorage.setItem(this.key, JSON.stringify(data)); }
};

function uid(){ return Math.random().toString(36).slice(2) }
function fmtRub(val){ return new Intl.NumberFormat('ru-RU').format(val) + '‚ÇΩ'; }

const App = {
  data: Store.load(),
  botUsername: 'majmarket_bot',

  route(name, param){
    location.hash = name + (param?':'+param:'');
    this.render();
  },
  toast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg; t.style.display='block';
    setTimeout(()=>t.style.display='none', 1600);
  },
  setActiveTab(name){
    ['home','trade','settings','moderation'].forEach(n=>{
      const el = document.getElementById('tab-'+n);
      if(el) el.classList.toggle('active', n===name);
    });
    const mod = document.getElementById('tab-mod');
    if(mod) mod.style.display = (this.data.role==='moderator'?'block':'none');
  },
  initUserFromTelegram(){
    try{
      const tg = window.Telegram?.WebApp;
      tg?.ready(); tg?.expand();
      const u = tg?.initDataUnsafe?.user;
      if(u){
        this.data.user = { id: u.id, username: u.username || u.first_name || ('user'+u.id) };
        Store.save(this.data);
        // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        API.call('/api/register','POST',{
          telegram_id: this.data.user.id,
          username: this.data.user.username
        }).catch(()=>{});
      }
    }catch(e){}
  },

  // ---------- Screens ----------
  screenHome(){
    const w = this.data.wallet;
    return `
      <div class="hero">
        <div class="row" style="justify-content:space-between">
          <h2>–ü—Ä–∏–≤–µ—Ç, ${this.data.user.username||'–ì–æ—Å—Ç—å'}</h2>
          <span class="chip">–ö—É—Ä—Å: 1 MJT = ${MJT_RUB}‚ÇΩ ‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è ${Math.round(FEE*100)}%</span>
        </div>
        <div class="row" style="margin:10px 0 12px">
          <div class="pill"><span class="ic">üí≥</span><div>–ë–∞–ª–∞–Ω—Å<br><span class="bignum">${w.balance} MJT</span> <span class="muted">‚âà ${fmtRub(w.balance*MJT_RUB)}</span></div></div>
          <div class="pill"><span class="ic">üîí</span><div>–í —É–¥–µ—Ä–∂–∞–Ω–∏–∏<br><span class="bignum">${w.hold} MJT</span> <span class="muted">‚âà ${fmtRub(w.hold*MJT_RUB)}</span></div></div>
        </div>
        <div class="row">
          <button class="btn" onclick="App.route('topup')">‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
          <button class="btn ghost" onclick="App.route('trade')">üõí –ö –∫–∞—Ç–∞–ª–æ–≥—É</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>–°–æ–≤–µ—Ç—ã –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h4>
        <div class="meta">–ù–µ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç–µ –≤–Ω–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã. –í—Å–µ–≥–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ —Ç–æ–≤–∞—Ä–∞. –í —Å–ø–æ—Ä–µ –ø–æ–º–æ–≥–∞—é—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç—ã/–≤–∏–¥–µ–æ.</div>
      </div>
    `;
  },

  async screenTrade(){
    const resp = await API.call('/api/listings');
    const list = resp.ok ? resp.data : [];
    return `
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3>–¢–æ—Ä–≥–æ–≤–ª—è</h3>
          <button class="btn sm" onclick="App.route('sell')">+ –í—ã—Å—Ç–∞–≤–∏—Ç—å</button>
        </div>
        <div class="toolbar">
          <input id="q" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é‚Ä¶"/>
          <select id="cat">
            <option value="">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</option>
            <option>–û–¥–µ–∂–¥–∞</option><option>–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</option>
            <option>–£—Ç–∏–ª–∏—Ç—ã</option><option>–£—Å–ª—É–≥–∏</option>
            <option>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option><option>–ü—Ä–æ—á–µ–µ</option>
          </select>
          <select id="srv"><option value="">–°–µ—Ä–≤–µ—Ä</option><option>RU1</option><option>RU2</option><option>RU3</option></select>
          <button class="btn secondary" onclick="App.render()">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
      <div class="grid" style="margin-top:12px">
        ${list.map(l=>`
          <div class="card product">
            <h4>${l.title}</h4>
            <div class="meta">${l.category} ‚Ä¢ ${l.server}</div>
            <div class="price">${l.price_mjt} MJT <span class="muted">‚âà ${fmtRub(l.price_mjt*MJT_RUB)}</span></div>
            <div class="toolbar">
              <button class="btn" onclick="App.route('order','${l.id}')">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  },

  screenSell(){
    return `
      <div class="card">
        <h3>–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h3>
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label><input id="t" placeholder="–ù–∞–ø—Ä. –•—É–¥–∏ Majestic"/>
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
          <select id="c"><option>–û–¥–µ–∂–¥–∞</option><option>–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</option><option>–£—Ç–∏–ª–∏—Ç—ã</option><option>–£—Å–ª—É–≥–∏</option><option>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option><option>–ü—Ä–æ—á–µ–µ</option></select>
        <label>–°–µ—Ä–≤–µ—Ä *</label>
          <select id="s"><option>RU1</option><option>RU2</option><option>RU3</option></select>
        <label>–¶–µ–Ω–∞ (MJT) *</label><input id="p" type="number" min="1" placeholder="1000"/>
        <div class="meta">‚âà –≤ —Ä—É–±–ª—è—Ö –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ: –∫—É—Ä—Å 1 MJT = ${MJT_RUB}‚ÇΩ</div>
        <div class="toolbar"><button class="btn" onclick="App.createListing()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
          <button class="btn secondary" onclick="App.route('trade')">–û—Ç–º–µ–Ω–∞</button></div>
      </div>
    `;
  },

  async screenOrder(listingId){
    // –ø–æ–¥–≥—Ä—É–∑–∏–º –ª–æ—Ç—ã –∏ –Ω–∞–π–¥—ë–º –Ω—É–∂–Ω—ã–π
    const resp = await API.call('/api/listings');
    const list = resp.ok ? resp.data : [];
    const l = list.find(x=>x.id===listingId);
    if(!l) return '<div class="card">–õ–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';

    const me = this.data.user.id;
    const isMine = String(l.seller_id) === String(me);

    // –ò—â–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫—ç—à–∞ (–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
    const o = this.data.orders_cache.find(x=>x.listing_id===listingId && x.buyer_id===me && x.status!=='completed');

    const actions = [];
    if (isMine) {
      actions.push(`<span class="chip">–≠—Ç–æ –≤–∞—à –ª–æ—Ç ‚Äî –∫—É–ø–∏—Ç—å –Ω–µ–ª—å–∑—è</span>`);
      actions.push(`<button class="btn secondary" onclick="App.route('trade')">–ù–∞–∑–∞–¥</button>`);
    } else if(!o){
      const fee = Math.round(l.price_mjt*FEE);
      actions.push(`<button class="btn" onclick="App.hold('${l.id}')">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ${l.price_mjt} MJT</button>`);
      actions.push(`<span class="chip">–ö–æ–º–∏—Å—Å–∏—è: ${fee} MJT (${fmtRub(fee*MJT_RUB)})</span>`);
    } else {
      // –º–æ–¥–µ–ª—å "–∫–∞–∫ –Æ–ª–∞": –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å
      if(o.status==='holded' && !o.buyer_confirm){
        actions.push(`<button class="btn" onclick="App.confirmReceived('${o.id}')">–Ø –ø–æ–ª—É—á–∏–ª —Ç–æ–≤–∞—Ä</button>`);
        actions.push(`<button class="btn secondary" onclick="App.toast('–û—Ç–∫—Ä—ã—Ç —Å–ø–æ—Ä (MVP)')">–û—Ç–∫—Ä—ã—Ç—å —Å–ø–æ—Ä</button>`);
      } else if (o.status==='completed'){
        actions.push(`<span class="chip">–°–¥–µ–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ</span>`);
      }
    }

    return `
      <div class="card">
        <h3>${l.title}</h3>
        <div class="meta">${l.category} ‚Ä¢ ${l.server}</div>
        <div class="price" style="margin:8px 0">${l.price_mjt} MJT <span class="muted">‚âà ${fmtRub(l.price_mjt*MJT_RUB)}</span></div>
        <div class="toolbar" style="margin-top:10px">${actions.join(' ')}</div>
      </div>
      <div class="card" style="margin-top:12px">
        <b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</b>
        <div class="meta">–≠—Å–∫—Ä–æ—É —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—É–º–º—É ‚Üí –ü–æ–ª—É—á–∏–ª–∏ —Ç–æ–≤–∞—Ä ‚Üí –ñ–º–∏—Ç–µ ¬´–Ø –ø–æ–ª—É—á–∏–ª —Ç–æ–≤–∞—Ä¬ª ‚Üí –í—ã–ø–ª–∞—Ç–∞ –ø—Ä–æ–¥–∞–≤—Ü—É (–∫–æ–º–∏—Å—Å–∏—è 3%).</div>
      </div>
    `;
  },

  screenSettings(){
    const w = this.data.wallet;
    return `
      <div class="hero">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <div class="row" style="margin:8px 0 12px">
          <div class="chip">–ë–∞–ª–∞–Ω—Å: <b>${w.balance}</b> MJT</div>
          <div class="chip">–í —É–¥–µ—Ä–∂–∞–Ω–∏–∏: <b>${w.hold}</b> MJT</div>
        </div>
        <div class="row">
          <button class="btn" onclick="App.route('topup')">‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
          <a class="btn ghost" href="https://t.me/${App.botUsername}?start=support" target="_blank" rel="noopener">–°–≤—è–∑—å —Å –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π</a>
        </div>
      </div>

      <div class="card">
        <h4>–ù–µ–¥–∞–≤–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</h4>
        <div class="meta">${(w.history.slice(-6).reverse().map(h=>`${h.kind} ¬∑ ${h.amount} MJT`).join(' ¬∑ ')) || '–ø–æ–∫–∞ –ø—É—Å—Ç–æ'}</div>
      </div>
    `;
  },

  screenTopup(){
    return `
      <div class="card">
        <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h3>
        <div class="range-wrap">
          <input id="topupRange" class="range" type="range" min="50" max="5000" step="50" value="500"
                 oninput="document.getElementById('topupVal').innerText=this.value"/>
          <div class="row" style="justify-content:space-between;margin-top:6px">
            <div>–°—É–º–º–∞: <b id="topupVal">500</b> MJT</div>
            <div class="muted">‚âà <span id="topupRub">${fmtRub(500*MJT_RUB)}</span></div>
          </div>
        </div>
        <div class="toolbar">
          <button class="btn" onclick="App.fakeTopup()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
          <button class="btn secondary" onclick="App.route('settings')">–ù–∞–∑–∞–¥</button>
        </div>
        <div class="meta">MVP: –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–º–æ (–±–µ–∑ –æ–Ω—á–µ–π–Ω/—ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞).</div>
      </div>
      <script>
        const rng = document.getElementById('topupRange');
        const rub = document.getElementById('topupRub');
        rng?.addEventListener('input', ()=>{ rub.textContent = new Intl.NumberFormat('ru-RU').format(rng.value*${MJT_RUB})+'‚ÇΩ'; });
      </script>
    `;
  },

  screenModeration(){
    if(this.data.role!=='moderator') return `<div class="card">–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º</div>`;
    return `
      <div class="card"><h3>–ö–æ–Ω—Ç—Ä–æ–ª—å —Å–¥–µ–ª–æ–∫</h3>
        <div class="meta">MVP: —Å–ø–æ—Ä—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å.</div>
      </div>
    `;
  },

  // ---------- Actions ----------
  async createListing(){
    const t = document.getElementById('t').value.trim();
    const c = document.getElementById('c').value;
    const s = document.getElementById('s').value;
    const p = parseInt(document.getElementById('p').value,10)||0;
    if(!t || !p){ this.toast('–ó–∞–ø–æ–ª–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É'); return; }
    const seller_id = this.data.user.id;
    const resp = await API.call('/api/listings','POST',{ seller_id, title:t, price_mjt:p, category:c, server:s });
    if(!resp.ok){ this.toast('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏'); return; }
    this.toast('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ');
    this.route('trade');
  },

  async hold(listingId){
    const buyer_id = this.data.user.id;
    const resp = await API.call('/api/orders','POST',{ listing_id: listingId, buyer_id });
    if(!resp.ok){ this.toast(resp.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞'); return; }
    // —Å–æ—Ö—Ä–∞–Ω–∏–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    this.data.orders_cache.push({ id: resp.data.id, listing_id, buyer_id, status:'holded', buyer_confirm:false });
    Store.save(this.data);
    this.toast('–£–¥–µ—Ä–∂–∞–Ω–æ (—ç—Å–∫—Ä–æ—É)');
    this.route('order', listingId);
  },

  async confirmReceived(orderId){
    const resp = await API.call('/api/orders','PATCH',{ order_id: orderId });
    if(!resp.ok){ this.toast('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è'); return; }
    // –æ–±–Ω–æ–≤–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
    const o = this.data.orders_cache.find(x=>x.id===orderId);
    if(o){ o.status='completed'; o.buyer_confirm=true; Store.save(this.data); }
    this.toast('–°–¥–µ–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ');
    this.route('home');
  },

  fakeTopup(){
    const rng = document.getElementById('topupRange');
    const amount = parseInt(rng?.value||'500',10);
    this.data.wallet.balance += amount;
    Store.save(this.data);
    this.toast(`+${amount} MJT`);
  },

  async notify(text){
    try{
      const chat_id = this.data.user.id;
      if(!chat_id) return;
      await API.call('/api/notify','POST',{ chat_id, text });
    }catch(e){}
  },

  async render(){
    const raw = (location.hash||'#home').replace('#','');
    const [name,param] = raw.split(':');
    this.setActiveTab(name);
    const el = document.getElementById('screen');

    // –µ—Å–ª–∏ –Ω–µ –∏–∑ Telegram ‚Äî –ø–æ–ø—Ä–æ—Å–∏–º –æ—Ç–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ –±–æ—Ç–∞
    if (!this.data.user.id) {
      const tg = window.Telegram?.WebApp;
      const u = tg?.initDataUnsafe?.user;
      if (!u) {
        el.innerHTML = \`
        <div class="card">
          <h3>–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –±–æ—Ç–∞</h3>
          <div class="meta">–ü–µ—Ä–µ–π–¥–∏ –≤ @\${this.botUsername} –∏ –Ω–∞–∂–º–∏ ¬´–û—Ç–∫—Ä—ã—Ç—å MajMarket¬ª</div>
          <div class="toolbar"><a class="btn" href="https://t.me/\${this.botUsername}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a></div>
        </div>\`;
        return;
      }
    }

    if(name==='home') el.innerHTML = this.screenHome();
    else if(name==='trade') el.innerHTML = await this.screenTrade();
    else if(name==='sell') el.innerHTML = this.screenSell();
    else if(name==='order') el.innerHTML = await this.screenOrder(param);
    else if(name==='settings') el.innerHTML = this.screenSettings();
    else if(name==='moderation') el.innerHTML = this.screenModeration();
    else if(name==='topup') el.innerHTML = this.screenTopup();
    else el.innerHTML = '<div class="card">–ù–µ—Ç —Ç–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã</div>';
  }
};

window.addEventListener('hashchange', ()=>App.render());
window.addEventListener('load', ()=>{
  try{ const tg = window.Telegram?.WebApp; tg?.ready(); tg?.expand(); tg?.MainButton?.hide(); }catch(e){}
  App.initUserFromTelegram();
  App.render();
});
</script>
</body>
</html>
