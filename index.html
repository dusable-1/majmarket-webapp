<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MajMarket</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#050507;
      --surface:#0B0B10;
      --surface2:#111117;
      --surface3:#181821;
      --line:rgba(255,255,255,0.06);
      --text:#FFFFFF;
      --muted:#CFCFDE;
      --accent:#E93E8F;
      --accent-soft:rgba(233,62,143,.18);
      --ok:#2DD688;
      --warn:#FACC15;
      --err:#FF4A4A;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:radial-gradient(circle at top,#181826 0%,#050507 55%,#020206 100%);
      color:var(--text);
      font:15px/1.45 -apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Inter,Roboto,Arial;
    }
    .app{min-height:100vh;display:flex;flex-direction:column}
    .container{max-width:980px;margin:0 auto;padding:16px 16px 104px}

    /* ===== HERO BALANCE CARD ===== */
    .hero{
      position:relative;
      border-radius:26px;
      padding:20px 18px 18px;
      margin:8px 0 16px;
      background:
        radial-gradient(circle at 0% 0%,rgba(233,62,143,0.4) 0%,rgba(233,62,143,0.06) 38%,rgba(8,8,12,1) 74%),
        linear-gradient(145deg,#161623 0%,#080811 100%);
      border:1px solid rgba(255,255,255,0.06);
      box-shadow:
        0 0 40px rgba(233,62,143,0.28),
        0 18px 40px rgba(0,0,0,0.85);
      overflow:hidden;
    }
    .hero::before{
      content:"";
      position:absolute;
      right:-40px;top:-40px;
      width:180px;height:180px;
      background:radial-gradient(circle,rgba(255,255,255,0.18),transparent 60%);
      opacity:.5;
      filter:blur(6px);
    }
    .title{
      display:flex;align-items:center;gap:12px;margin-bottom:8px;position:relative;z-index:1;
    }
    .badge{
      width:38px;height:38px;border-radius:14px;
      background:linear-gradient(145deg,#1F1F2C,#101018);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;font-size:18px;color:var(--accent);
      box-shadow:0 0 24px rgba(233,62,143,0.45);
    }
    .title-main{font-weight:700;font-size:16px}
    .title-sub{color:var(--muted);font-size:13px;opacity:.85}
    .balance{
      display:flex;align-items:flex-end;gap:10px;margin:12px 0 14px;position:relative;z-index:1;
    }
    .amount{
      font-size:40px;font-weight:800;letter-spacing:.4px;
      background:linear-gradient(90deg,#FFFFFF,#F7B2DA,#FFFFFF);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }
    .sub{color:var(--muted);font-size:13px;opacity:.9}

    .actions{
      display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:6px;position:relative;z-index:1;
    }
    .tile{
      display:flex;flex-direction:column;align-items:center;gap:10px;
      background:radial-gradient(circle at 0% 0%,rgba(233,62,143,0.12),transparent 60%),
                 linear-gradient(160deg,#111119,#08080D);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:20px;padding:14px 10px;cursor:pointer;user-select:none;
      box-shadow:0 16px 30px rgba(0,0,0,0.85);
      transition:transform .16s ease-out, box-shadow .16s ease-out, border-color .16s ease-out, background .16s ease-out;
    }
    .tile:hover{
      transform:translateY(-2px);
      border-color:rgba(233,62,143,0.4);
      box-shadow:0 22px 40px rgba(0,0,0,0.95);
      background:radial-gradient(circle at 0% 0%,rgba(233,62,143,0.24),transparent 60%),
                 linear-gradient(160deg,#151522,#090910);
    }
    .tile i{
      width:46px;height:46px;border-radius:18px;
      background:radial-gradient(circle at 0% 0%,rgba(233,62,143,0.36),rgba(7,7,12,1));
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 24px rgba(233,62,143,0.7);
    }
    .tile i b{
      color:#fff;font-size:20px;font-weight:800;line-height:1;
    }
    .tile span{font-size:12px;color:var(--muted);}

    /* BASIC */
    .row{display:flex;flex-wrap:wrap;gap:8px}
    .btn{
      background:var(--accent);border:0;color:#fff;border-radius:14px;
      padding:10px 14px;font-weight:600;font-size:13px;cursor:pointer;
      display:inline-flex;align-items:center;gap:6px;
      box-shadow:0 14px 26px rgba(233,62,143,0.4);
      transition:transform .14s ease-out, box-shadow .14s ease-out, background .14s ease-out;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 18px 30px rgba(233,62,143,0.6);
      background:#F14899;
    }
    .btn.secondary{
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.1);
      box-shadow:none;
    }
    .btn.secondary:hover{
      background:rgba(255,255,255,0.07);
    }
    .btn.ghost{
      background:transparent;border:1px solid rgba(255,255,255,0.12);box-shadow:none;
    }

    .card{
      background:linear-gradient(160deg,#101019,#07070D);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:22px;padding:16px 14px;
      box-shadow:0 20px 35px rgba(0,0,0,0.9);
      margin-bottom:12px;
    }
    .card h3,.card h4{margin:0 0 8px;font-weight:600;font-size:16px}
    .meta{color:var(--muted);font-size:13px;margin:2px 0 8px;opacity:.9}
    .price{color:var(--accent);font-weight:800;font-size:16px}

    input,select,textarea{
      width:100%;background:#050509;color:#fff;border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;padding:12px 12px;font-size:14px;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(233,62,143,0.6);
    }
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px;opacity:.9}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:10px}
    .product{
      background:radial-gradient(circle at 0% 0%,rgba(233,62,143,0.12),transparent 65%),
                 linear-gradient(165deg,#101019,#080810);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:20px;padding:14px 14px 12px;
      box-shadow:0 16px 30px rgba(0,0,0,0.9);
    }
    .product h4{margin:0 0 6px;font-size:14px;font-weight:600}

    .chip{
      border-radius:999px;
      padding:6px 12px;
      font-size:12px;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.08);
      color:var(--muted);
      display:inline-flex;align-items:center;gap:6px;
    }
    .chip b{font-weight:600}

    /* status chips */
    .chip-status{
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
      letter-spacing:0.02em;
      text-transform:uppercase;
    }
    .chip-holded{
      background:rgba(250,204,21,0.12);
      border:1px solid rgba(250,204,21,0.4);
      color:#FACC15;
    }
    .chip-dispute{
      background:rgba(255,74,74,0.12);
      border:1px solid rgba(255,74,74,0.5);
      color:#FF6B6B;
    }
    .chip-completed{
      background:rgba(45,214,136,0.12);
      border:1px solid rgba(45,214,136,0.6);
      color:#4ADE80;
    }

    /* ===== tabbar ===== */
    .tabbar{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(3,3,6,0.92);
      backdrop-filter:blur(24px);
      border-top:1px solid rgba(255,255,255,0.08);
      display:flex;padding:6px 10px 10px;
    }
    .tabbar .item{
      position:relative;
      flex:1;background:transparent;border:0;color:#7C7C94;
      display:flex;flex-direction:column;align-items:center;gap:4px;
      padding:6px 4px 6px;font-weight:600;font-size:11px;
    }
    .tabbar .icoBox{
      width:30px;height:30px;border-radius:12px;
      background:rgba(255,255,255,0.04);
      display:flex;align-items:center;justify-content:center;
    }
    .tabbar .icoBox b{
      color:var(--muted);font-size:16px;font-weight:700;
    }
    .tabbar .item .lbl{font-size:11px}
    .tabbar .item.active{
      color:var(--accent);
    }
    .tabbar .item.active .icoBox{
      background:radial-gradient(circle at 0% 0%,rgba(233,62,143,0.45),rgba(10,10,18,1));
      box-shadow:0 0 18px rgba(233,62,143,0.8);
    }
    .tabbar .item.active .icoBox b{
      color:#fff;
    }
    .tabbar .item.active::after{
      content:"";
      position:absolute;
      bottom:0;left:50%;transform:translateX(-50%);
      width:40%;height:3px;
      border-radius:999px;
      background:linear-gradient(90deg,rgba(233,62,143,0.1),var(--accent),rgba(233,62,143,0.1));
    }

    /* range */
    input[type=range]{-webkit-appearance:none;width:100%;background:transparent}
    input[type=range]::-webkit-slider-runnable-track{
      height:6px;background:#2B2B33;border-radius:999px;
    }
    input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none;height:22px;width:22px;background:var(--accent);
      border-radius:50%;margin-top:-8px;cursor:pointer;border:0;
      box-shadow:0 0 14px rgba(233,62,143,0.8);
    }
    input[type=range]:focus::-webkit-slider-runnable-track{background:#3A3A44}

    /* toast */
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:104px;
      background:#0B0B12;border:1px solid rgba(255,255,255,0.14);
      padding:10px 14px;border-radius:999px;display:none;z-index:20;
      font-size:13px;color:var(--text);
      box-shadow:0 16px 30px rgba(0,0,0,0.9);
    }
  </style>
</head>
<body>
<div class="app">
  <div class="container"><div id="screen"></div></div>

  <div class="tabbar">
    <button class="tab item" data-tab="home" onclick="App.route('home')">
      <span class="icoBox"><b>‚åÇ</b></span><span class="lbl">–ì–ª–∞–≤–Ω–∞—è</span>
    </button>
    <button class="tab item" data-tab="trade" onclick="App.route('trade')">
      <span class="icoBox"><b>‚Üó</b></span><span class="lbl">–¢–æ—Ä–≥–æ–≤–ª—è</span>
    </button>
    <button class="tab item" data-tab="settings" onclick="App.route('settings')">
      <span class="icoBox"><b>‚öôÔ∏é</b></span><span class="lbl">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
    </button>
    <button class="tab item" id="tab-mod" data-tab="moderation" onclick="App.route('moderation')">
      <span class="icoBox"><b>üõ°</b></span><span class="lbl">–ú–æ–¥–µ—Ä–∞—Ü–∏—è</span>
    </button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const API_BASE = 'https://YOUR_NGROK_URL_HERE'; // üî¥ —Å—é–¥–∞ –≤—Å—Ç–∞–≤—å https://xxxxx.ngrok.io

const App = {
  data: {
    user: {},
    role: 'user',
    wallet: { balance: 0, hold: 0, history: [] },
    listings: [],
    orders: []
  },
  loading:false,

  async syncState(){
    const userId = this.data.user && this.data.user.id;
    if(!userId){ this.render(); return; }
    try{
      this.loading = true;
      const res = await fetch(API_BASE + '/api/state?user_id='+encodeURIComponent(userId));
      if(!res.ok) throw new Error('state_error');
      const state = await res.json();
      state.user = { id:this.data.user.id, username:this.data.user.username };
      this.data = state;
    }catch(e){
      console.error('syncState error',e);
    }finally{
      this.loading=false;
      this.render();
    }
  },

  route(name,param){ location.hash = name + (param?':'+param:''); this.render(); },

  toast(msg){
    const t=document.getElementById('toast');
    t.textContent=msg; t.style.display='block';
    setTimeout(()=>t.style.display='none',1700);
  },

  setActiveTab(name){
    document.querySelectorAll('.tabbar .item').forEach(el=>{
      el.classList.toggle('active', el.dataset.tab===name);
    });
    const mod=document.getElementById('tab-mod');
    if(mod) mod.style.display=(this.data.role==='moderator'?'flex':'none');
  },

  openModerators(){
    try{
      const url="https://t.me/majmarket_bot";
      if(window.Telegram?.WebApp?.openTelegramLink) window.Telegram.WebApp.openTelegramLink(url);
      else window.open(url,"_blank","noopener");
    }catch(e){ window.open("https://t.me/majmarket_bot","_blank","noopener"); }
  },

  initUserFromTelegram(){
    try{
      const tg=window.Telegram?.WebApp;
      tg?.ready(); tg?.expand(); tg?.MainButton?.hide();
      const u=tg?.initDataUnsafe?.user;
      if(u){
        this.data.user={id:u.id,username:u.username||u.first_name||('user'+u.id)};
      }
    }catch(e){}
  },

  async notify(text){
    try{
      const chat_id=this.data.user.id;
      if(!chat_id) return;
      await fetch(API_BASE+'/api/notify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id,text})});
    }catch(e){console.error('notify',e);}
  },
  async notifyTo(chat_id,text){
    try{
      if(!chat_id) return;
      await fetch(API_BASE+'/api/notify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id,text})});
    }catch(e){console.error('notifyTo',e);}
  },

  screenHome(){
    const w=this.data.wallet||{balance:0,hold:0};
    const u=this.data.user.username||'–ì–æ—Å—Ç—å';
    const recent=(this.data.orders||[]).slice(-8).reverse().map(o=>{
      const l=(this.data.listings||[]).find(x=>x.id===o.listing_id);
      const statusClass = o.status==='holded'
        ? 'chip-holded'
        : o.status==='dispute'
          ? 'chip-dispute'
          : o.status==='completed'
            ? 'chip-completed'
            : '';
      return `
        <div class="chip">
          <span>#${o.id.slice(0,5)}</span>
          <span>¬∑ ${l?.title||'–õ–æ—Ç'}</span>
          <span>¬∑</span>
          <span class="chip-status ${statusClass}">${o.status}</span>
        </div>`;
    }).join('') || '<span class="chip">–ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</span>';

    return `
      <div class="hero">
        <div class="title">
          <div class="badge">M</div>
          <div>
            <div class="title-main">MajMarket</div>
            <div class="title-sub">–ü—Ä–∏–≤–µ—Ç, ${u} üëã</div>
          </div>
        </div>
        <div class="balance">
          <div class="amount">${w.balance} MJT</div>
          <div class="sub">–≤ —É–¥–µ—Ä–∂–∞–Ω–∏–∏: ${w.hold}</div>
        </div>
        <div class="actions">
          <div class="tile" onclick="App.route('topup')"><i><b>Ôºã</b></i><span>–ü–æ–ø–æ–ª–Ω–∏—Ç—å</span></div>
          <div class="tile" onclick="App.route('trade')"><i><b>‚Üì</b></i><span>–ü–æ–∫—É–ø–∫–∞</span></div>
          <div class="tile" onclick="App.route('sell')"><i><b>‚Üë</b></i><span>–ü—Ä–æ–¥–∞–∂–∞</span></div>
        </div>
      </div>

      <div class="card">
        <h4>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏ / –ø—Ä–æ–¥–∞–∂–∏</h4>
        <div class="row" style="margin-top:4px">${recent}</div>
      </div>
    `;
  },

  screenTrade(){
    const list=(this.data.listings||[])
      .filter(x=>x.status==='active')
      .sort((a,b)=>b.created_at-a.created_at);

    return `
      <div class="card">
        <h3>–¢–æ—Ä–≥–æ–≤–ª—è</h3>
        <div class="meta">–í—ã–±–∏—Ä–∞–π –ª–æ—Ç –∏ –±–ª–æ–∫–∏—Ä—É–π MJT —á–µ—Ä–µ–∑ —ç—Å–∫—Ä–æ—É.</div>
        <div class="toolbar">
          <input id="q" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é‚Ä¶"/>
          <select id="cat">
            <option value="">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</option>
            <option>–û–¥–µ–∂–¥–∞</option><option>–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</option>
            <option>–£—Ç–∏–ª–∏—Ç—ã</option><option>–£—Å–ª—É–≥–∏</option>
            <option>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option><option>–ü—Ä–æ—á–µ–µ</option>
          </select>
          <select id="srv"><option value="">–°–µ—Ä–≤–µ—Ä</option><option>RU1</option><option>RU2</option><option>RU3</option></select>
          <button class="btn secondary" onclick="App.render()">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn" onclick="App.route('sell')">+ –í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–¥–∞–∂—É</button>
        </div>
      </div>

      <div class="grid">
        ${list.map(l=>`
          <div class="product">
            <h4>${l.title}</h4>
            <div class="meta">${l.category} ‚Ä¢ ${l.server}</div>
            <div class="price">${l.price_mjt} MJT</div>
            <div class="toolbar" style="margin-top:6px">
              <button class="btn" onclick="App.route('order','${l.id}')">–ö—É–ø–∏—Ç—å</button>
              <button class="btn ghost" onclick="App.toast('–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî —Å–∫–æ—Ä–æ')">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  },

  screenSell(){
    return `
      <div class="card">
        <h3>–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h3>
        <div class="meta">–û–ø–∏—à–∏ —Ç–æ–≤–∞—Ä —á–µ—Å—Ç–Ω–æ ‚Äî –æ—Ç —ç—Ç–æ–≥–æ –∑–∞–≤–∏—Å–∏—Ç –¥–æ–≤–µ—Ä–∏–µ.</div>
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label><input id="t" placeholder="–ù–∞–ø—Ä. –•—É–¥–∏ Majestic"/>
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
        <select id="c">
          <option>–û–¥–µ–∂–¥–∞</option><option>–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</option>
          <option>–£—Ç–∏–ª–∏—Ç—ã</option><option>–£—Å–ª—É–≥–∏</option>
          <option>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option><option>–ü—Ä–æ—á–µ–µ</option>
        </select>
        <label>–°–µ—Ä–≤–µ—Ä *</label>
        <select id="s"><option>RU1</option><option>RU2</option><option>RU3</option></select>
        <label>–¶–µ–Ω–∞ (MJT) *</label><input id="p" type="number" min="1" placeholder="1000"/>
        <div class="toolbar" style="margin-top:10px">
          <button class="btn" onclick="App.createListing()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    `;
  },

  screenOrder(listingId){
    const l=(this.data.listings||[]).find(x=>x.id===listingId);
    if(!l) return `<div class="card">–õ–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>`;

    const me=this.data.user.id;
    const isSelf=String(l.seller)===String(me);

    const o=(this.data.orders||[]).slice().reverse().find(o =>
      o.listing_id===l.id && o.buyer_id===me && !['completed','refunded'].includes(o.status)
    );

    const actions=[];
    if(isSelf){
      actions.push(`<span class="chip">–≠—Ç–æ –≤–∞—à –ª–æ—Ç ‚Äî –∫—É–ø–∏—Ç—å –Ω–µ–ª—å–∑—è</span>`);
      actions.push(`<button class="btn secondary" onclick="App.route('trade')">–ù–∞–∑–∞–¥</button>`);
    }else if(!o){
      actions.push(`<button class="btn" onclick="App.hold('${l.id}')">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ${l.price_mjt} MJT</button>`);
    }else{
      if(o.status==='holded' && !o.buyer_confirm){
        actions.push(`<button class="btn" onclick="App.confirmReceived('${o.id}')">–Ø –ø–æ–ª—É—á–∏–ª —Ç–æ–≤–∞—Ä</button>`);
        actions.push(`<button class="btn secondary" onclick="App.dispute('${o.id}')">–û—Ç–∫—Ä—ã—Ç—å —Å–ø–æ—Ä</button>`);
      }else if(o.status==='completed'){
        actions.push(`<span class="chip"><b>–°–¥–µ–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ</b></span>`);
      }else if(o.status==='dispute'){
        actions.push(`<span class="chip"><b>–°–ø–æ—Ä —É –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤</b></span>`);
      }
    }

    return `
      <div class="card">
        <h3>${l.title}</h3>
        <div class="meta">${l.category} ‚Ä¢ ${l.server}</div>
        <div class="price" style="margin:6px 0 10px">${l.price_mjt} MJT</div>
        <div class="toolbar">${actions.join(' ')}</div>
      </div>
      <div class="card">
        <h4>–°—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏</h4>
        <div class="meta">${
          o ? `${o.status}${o.buyer_confirm?' ‚Ä¢ buyer‚úî':''}` : (isSelf?'–≤–∞—à –ª–æ—Ç':'—Å–¥–µ–ª–∫–∞ –µ—â—ë –Ω–µ –Ω–∞—á–∞—Ç–∞')
        }</div>
        <div class="meta">–≠—Å–∫—Ä–æ—É —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ ‚Üí –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç ‚Üí –í—ã–ø–ª–∞—Ç–∞ –ø—Ä–æ–¥–∞–≤—Ü—É (–∫–æ–º–∏—Å—Å–∏—è 3%). –°–ø–æ—Ä ‚Äî –º–æ–¥–µ—Ä–∞—Ü–∏—è.</div>
      </div>
    `;
  },

  screenSettings(){
    const w=this.data.wallet||{balance:0,hold:0};
    return `
      <div class="card">
        <h3>–ö–æ—à–µ–ª—ë–∫</h3>
        <div class="row" style="margin:8px 0 10px">
          <div class="chip">–ë–∞–ª–∞–Ω—Å: <b>${w.balance}</b> MJT</div>
          <div class="chip">–í —É–¥–µ—Ä–∂–∞–Ω–∏–∏: <b>${w.hold}</b> MJT</div>
        </div>
        <div class="toolbar">
          <button class="btn" onclick="App.route('topup')">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
          <button class="btn secondary" onclick="App.openModerators()">–ß–∞—Ç —Å –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π</button>
        </div>
      </div>
      <div class="card">
        <h4>–ù–µ–¥–∞–≤–Ω–∏–µ –∑–∞–∫–∞–∑—ã</h4>
        <div class="meta">${
          (this.data.orders||[]).slice(-5).reverse().map(o=>`#${o.id.slice(0,5)} ¬∑ ${o.status}`).join(' ¬∑ ') || '–ø–æ–∫–∞ –ø—É—Å—Ç–æ'
        }</div>
      </div>
    `;
  },

  screenModeration(){
    if(this.data.role!=='moderator') return `<div class="card">–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º</div>`;
    const open=(this.data.orders||[]).filter(o=>o.status==='dispute').slice(-20).reverse();
    return `
      <div class="card">
        <h3>–ö–æ–Ω—Ç—Ä–æ–ª—å —Å–¥–µ–ª–æ–∫</h3>
        ${open.length ? open.map(o=>`
          <div class="row" style="margin:8px 0">
            <div class="chip">#${o.id.slice(0,5)}</div>
            <button class="btn secondary" onclick="App.modResolve('${o.id}','release')">Release</button>
            <button class="btn secondary" onclick="App.modResolve('${o.id}','refund')">Refund</button>
          </div>
        `).join('') : '<div class="meta">–°–ø–æ—Ä–æ–≤ –Ω–µ—Ç</div>'}
      </div>
    `;
  },

  screenTopup(){
    const start=1000;
    return `
      <div class="card">
        <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ MJT</h3>
        <div class="meta">–ü–æ–ª–∑—É–Ω–æ–∫ –∏–ª–∏ —Å—É–º–º–∞ –≤—Ä—É—á–Ω—É—é.</div>
        <label>–°—É–º–º–∞ (MJT)</label>
        <input id="topupAmount" type="number" min="100" max="1000000" step="100" value="${start}" oninput="document.getElementById('topupRange').value=this.value"/>
        <label>–ü–æ–ª–∑—É–Ω–æ–∫</label>
        <input id="topupRange" type="range" min="100" max="100000" step="100" value="${start}" oninput="document.getElementById('topupAmount').value=this.value"/>
        <div class="toolbar" style="margin-top:8px">
          <button class="btn" onclick="App.doTopup()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
          <button class="btn secondary" onclick="App.route('settings')">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    `;
  },

  async createListing(){
    const t=document.getElementById('t').value.trim();
    const c=document.getElementById('c').value;
    const s=document.getElementById('s').value;
    const p=parseInt(document.getElementById('p').value,10)||0;
    if(!t||!p){this.toast('–ó–∞–ø–æ–ª–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É');return;}
    try{
      const body={seller_id:this.data.user.id,title:t,category:c,server:s,price_mjt:p};
      const res=await fetch(API_BASE+'/api/listings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const data=await res.json();
      if(!res.ok||!data.ok){this.toast(data.error||'–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');return;}
      await this.syncState();
      this.toast('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ');
      this.route('trade');
    }catch(e){console.error('createListing',e);this.toast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');}
  },

  async hold(listingId){
    const l=(this.data.listings||[]).find(x=>x.id===listingId);
    if(!l){this.toast('–õ–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');return;}
    if(String(l.seller)===String(this.data.user.id||'me')){this.toast('–ù–µ–ª—å–∑—è –∫—É–ø–∏—Ç—å —Å–≤–æ–π –ª–æ—Ç');return;}
    try{
      const res=await fetch(API_BASE+'/api/orders/hold',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({listing_id:listingId,buyer_id:this.data.user.id})});
      const data=await res.json();
      if(!res.ok||!data.ok){
        if(data.error==='not_enough_balance') this.toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ MJT');
        else if(data.error==='cannot_buy_own_listing') this.toast('–ù–µ–ª—å–∑—è –∫—É–ø–∏—Ç—å —Å–≤–æ–π –ª–æ—Ç');
        else this.toast(data.error||'–û—à–∏–±–∫–∞ —Å–¥–µ–ª–∫–∏');
        return;
      }
      this.toast(`–£–¥–µ—Ä–∂–∞–Ω–æ ${l.price_mjt} MJT`);
      await this.notify(`–£–¥–µ—Ä–∂–∞–Ω–æ ${l.price_mjt} MJT –ø–æ –∑–∞–∫–∞–∑—É #${data.order.id.slice(0,5)}. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–¥–∞—á–∏.`);
      await this.notifyTo(l.seller,`–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #${data.order.id.slice(0,5)} –Ω–∞ ¬´${l.title}¬ª –∑–∞ ${l.price_mjt} MJT. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è.`);
      await this.syncState();
      this.route('order',l.id);
    }catch(e){console.error('hold',e);this.toast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');}
  },

  async confirmReceived(orderId){
    try{
      const res=await fetch(API_BASE+'/api/orders/confirm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({order_id:orderId,user_id:this.data.user.id})});
      const data=await res.json();
      if(!res.ok||!data.ok){this.toast(data.error||'–ù–µ–≤–µ—Ä–Ω—ã–π —Å—Ç–∞—Ç—É—Å');return;}
      this.toast('–°–¥–µ–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ');
      await this.notify('–°–ø–∞—Å–∏–±–æ! –í—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏–µ. –°–¥–µ–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.');
      const order=data.order;
      const fee=Math.round(order.price*0.03);
      await this.notifyTo(order.seller_id,`–ó–∞–∫–∞–∑ #${order.id.slice(0,5)} –∑–∞–≤–µ—Ä—à—ë–Ω. –í—ã–ø–ª–∞—Ç–∞: ${order.price-fee} MJT (–∫–æ–º–∏—Å—Å–∏—è ${fee}).`);
      await this.syncState();
      this.route('home');
    }catch(e){console.error('confirmReceived',e);this.toast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');}
  },

  async dispute(orderId){
    try{
      const res=await fetch(API_BASE+'/api/orders/dispute',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({order_id:orderId,user_id:this.data.user.id})});
      const data=await res.json();
      if(!res.ok||!data.ok){this.toast(data.error||'–û—à–∏–±–∫–∞ —Å–ø–æ—Ä–∞');return;}
      this.toast('–û—Ç–∫—Ä—ã—Ç —Å–ø–æ—Ä ‚Äî –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω—ã');
      const o=data.order;
      await this.notifyTo(o.seller_id,`–ü–æ –∑–∞–∫–∞–∑—É #${o.id.slice(0,5)} –æ—Ç–∫—Ä—ã—Ç —Å–ø–æ—Ä.`);
      await this.notify('–ú—ã —Å–æ–æ–±—â–∏–ª–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º. –û–∂–∏–¥–∞–π—Ç–µ —Å–≤—è–∑–∏.');
      await this.syncState();
    }catch(e){console.error('dispute',e);this.toast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');}
  },

  async modResolve(orderId,decision){
    try{
      const res=await fetch(API_BASE+'/api/mod/resolve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({order_id:orderId,decision})});
      const data=await res.json();
      if(!res.ok||!data.ok){this.toast(data.error||'–û—à–∏–±–∫–∞ —Ä–µ—à–µ–Ω–∏—è');return;}
      this.toast(`–†–µ—à–µ–Ω–∏–µ: ${decision}`);
      await this.syncState();
    }catch(e){console.error('modResolve',e);this.toast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');}
  },

  async doTopup(){
    const el=document.getElementById('topupAmount');
    const amt=Math.max(100,parseInt(el.value,10)||0);
    try{
      const res=await fetch(API_BASE+'/api/topup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:this.data.user.id,amount:amt})});
      const data=await res.json();
      if(!res.ok||!data.ok){this.toast(data.error||'–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è');return;}
      this.toast(`+${amt} MJT`);
      await this.notify(`–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${amt} MJT`);
      await this.syncState();
      this.route('settings');
    }catch(e){console.error('doTopup',e);this.toast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');}
  },

  render(){
    const raw=(location.hash||'#home').replace('#','');
    const [name,param]=raw.split(':');
    const known=['home','trade','sell','order','settings','moderation','topup'];
    if(!known.includes(name)){this.route('home');return;}
    this.setActiveTab(name);
    const el=document.getElementById('screen');
    if(this.loading){el.innerHTML='<div class="card">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';return;}
    if(name==='home') el.innerHTML=this.screenHome();
    else if(name==='trade') el.innerHTML=this.screenTrade();
    else if(name==='sell') el.innerHTML=this.screenSell();
    else if(name==='order') el.innerHTML=this.screenOrder(param);
    else if(name==='settings') el.innerHTML=this.screenSettings();
    else if(name==='moderation') el.innerHTML=this.screenModeration();
    else if(name==='topup') el.innerHTML=this.screenTopup();
  }
};

window.addEventListener('hashchange',()=>App.render());
window.addEventListener('load',async()=>{
  if(!location.hash) location.hash='home';
  try{
    const tg=window.Telegram?.WebApp;
    tg?.ready();tg?.expand();tg?.MainButton?.hide();
  }catch(e){}
  App.initUserFromTelegram();
  await App.syncState();
});
</script>
</body>
</html>
